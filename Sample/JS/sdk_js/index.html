<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <title>Video Call Sample</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <link
            href="https://fonts.googleapis.com/css?family=Nunito:300,300i,400,400i,600,600i,700,700i&display=swap"
            rel="stylesheet"
        />
        <link
            href="https://fonts.googleapis.com/icon?family=Material+Icons|Material+Icons+Outlined"
            rel="stylesheet"
        />
        <link
            rel="stylesheet"
            href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
            integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm"
            crossorigin="anonymous"
        />
        <script
            src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
            integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
            crossorigin="anonymous"
        ></script>
        <script
            src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
            integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
            crossorigin="anonymous"
        ></script>
        <script
            src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
            integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
            crossorigin="anonymous"
        ></script>
        <script src="https://meet.jit.si/external_api.js"></script>
        <script
            src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"
            integrity="sha512-iKDtgDyTHjAitUDdLljGhenhPwrbBfqTKWO1mkhSFH3A7blITC9MhYon6SjnMhp4o0rADGw9yAC6EW4t5a4K3g=="
            crossorigin="anonymous"
        ></script>
    </head>
    <body>
        <script src="video-call-js-sdk/VideoCall.js"></script>
        <script type="text/javascript" src="ConfigVideoCall.js"></script>
        <link rel="stylesheet" href="video-call-js-sdk/style-caller.css" />
        <div>
            <link
                href="https://fonts.googleapis.com/css?family=Nunito:300,300i,400,400i,600,600i,700,700i&display=swap"
                rel="stylesheet"
            />
            <link
                href="https://fonts.googleapis.com/icon?family=Material+Icons|Material+Icons+Outlined"
                rel="stylesheet"
            />
            <span class="ml-2">Video call sample (version 3.0.0)</span>
            <div class="spacer"></div>
            <button
                class="btn btn-success d-inline-flex mr-2"
                id="user"
                onclick="createUUID()"
            >
                Tạo UUID (nếu lần đầu mở app)
            </button>
            <button
                class="btn btn-success d-inline-flex mr-2"
                id="admin"
                onclick="loginAs('admin')"
            >
                Bước 3: Register device (admin)
            </button>

            <button
                class="btn btn-warning d-inline-flex mr-2"
                id="user"
                onclick="logout()"
            >
                Logout
            </button>
        </div>

        <div class="content" role="main">
            <div class="col-12 container-fluid">
                <ul class="list-group list-group-flush">
                    <li class="list-group-item">
                        <div class="row mb-2">
                            <div class="col-8">
                                <input
                                    type="text"
                                    class="form-control"
                                    id="uuidAdmin"
                                />
                            </div>
                            <div class="col-4">
                                <button
                                    type="button"
                                    class="btn btn-success"
                                    onclick="setUUID('admin')"
                                >
                                    Bước 1: Thiết lập UUID nguồn (có thể có hoặc
                                    không)
                                </button>
                            </div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-8">
                                <input
                                    type="text"
                                    class="form-control"
                                    id="uuidUser"
                                />
                            </div>
                            <div class="col-4">
                                <button
                                    type="button"
                                    class="btn btn-success"
                                    onclick="setUUID('user')"
                                >
                                    Bước 2: Thiết lập UUID đích (user)
                                </button>
                            </div>
                        </div>
                        <div class="row mb-2">
                            <div class="col-8">
                                <input
                                    type="text"
                                    class="form-control"
                                    id="tokenIdAppDest"
                                />
                            </div>
                            <div class="col-4">
                                <button
                                    type="button"
                                    class="btn btn-success"
                                    onclick="setUUID('tokenIdAppDest')"
                                >
                                    Bước 4: Thiết lập token id app destination
                                </button>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-8">
                                <p class="pt-2" id="uuidUserText"></p>
                            </div>
                            <div class="col-4">
                                <button
                                    type="button"
                                    class="btn btn-success"
                                    onclick="callVideo()"
                                >
                                    Gọi tới user đích
                                </button>
                            </div>
                        </div>
                    </li>

                    <button
                        type="button"
                        class="btn btn-success"
                        onclick="getFile()"
                    >
                        Get file
                    </button>
                    <iframe
                        class="home__hero__video"
                        id="urlVideo"
                        webkitallowfullscreen
                        mozallowfullscreen
                        allowfullscreen
                        height="500"
                    >
                    </iframe>
                    <div id="meet" style="height: 100vh"></div>
                </ul>
            </div>
        </div>

        <script>
            var createCallUser = false;
            //init config cho sdk
            const video = VideoCallSDK.initConfig(
                null,
                ConfigVideoCall,
                window.JitsiMeetExternalAPI
            );

            // Khai báo biến cần thiết
            const uuidAdmin = localStorage.getItem('uuidAdmin')
                ? localStorage.getItem('uuidAdmin').replace(/"/g, '')
                : video.createUUID();
            const uuidUser = localStorage.getItem('uuidUser')
                ? localStorage.getItem('uuidUser').replace(/"/g, '')
                : video.createUUID();

            // khai báo token id app của hệ thống muốn gọi đến
            // trong sample chỉ thực hiện set động để phục vụ việc test
            // có thể set cứng tùy vào hệ thống muốn gọi vào
            const tokenIdAppDest = localStorage.getItem('tokenIdAppDest')
                ? localStorage.getItem('tokenIdAppDest').replace(/"/g, '')
                : '01ebcf7e-1a5c-1080-82a1-10a45c074591';

            // thực hiện connect tới socket
            video.initSocket(
                Stomp,
                uuidAdmin,
                (success) => {
                    console.log(success);
                },
                (event) => {
                    // alert(event.title);
                    // if (event.title === 'ACCEPTED' && !createCallUser) {
                    //     window.location.href =
                    //         'file:///C:/Users/Hi/Desktop/JS_SDK/Sample/JS/sdk_js/call.html';
                    // }
                },
                true
            );

            document.getElementById('uuidAdmin').value = uuidAdmin;
            document.getElementById('uuidUser').value = uuidUser;
            document.getElementById('uuidUserText').innerHTML = uuidUser;
            document.getElementById('tokenIdAppDest').value = tokenIdAppDest;

            //hàm thực hiện xóa device khi logout
            function logout() {
                video.removeDevice(uuidAdmin);
            }

            function createUUID() {
                video.createUUID();
            }

            function setUUID(type) {
                const uuidAdminValue =
                    document.getElementById('uuidAdmin').value;
                const uuidUserValue = document.getElementById('uuidUser').value;
                const tokenIdAppDest =
                    document.getElementById('tokenIdAppDest').value;
                document.getElementById('uuidUserText').innerHTML =
                    uuidUserValue;
                alert(type);
                if (type === 'tokenIdAppDest') {
                    localStorage.setItem(
                        'tokenIdAppDest',
                        JSON.stringify(tokenIdAppDest)
                    );
                }
                if (type === 'admin') {
                    localStorage.setItem(
                        'uuidAdmin',
                        JSON.stringify(uuidAdminValue)
                    );
                } else {
                    localStorage.setItem(
                        'uuidUser',
                        JSON.stringify(uuidUserValue)
                    );
                }
            }

            //gọi video
            async function callVideo() {
                const callerIdDest = localStorage
                    .getItem('uuidUser')
                    .replace(/"/g, '');
                const additionalData = {
                    caller: 'smcs',
                };
                const res = await video.createCall(
                    uuidAdmin,
                    'Nguyễn Văn Lâm',
                    callerIdDest,
                    localStorage.getItem('tokenIdAppDest').replace(/"/g, ''), // thên 1 tham số token id app của hệ thống muốn gọi đến
                    additionalData
                );
                createCallUser = true;

                // window.location.href =
                //     'file:///C:/Users/Hi/Desktop/JS_SDK/Sample/JS/sdk_js/call.html';
                console.log('call', res);
            }

            //get url file record
            async function getFile() {
                const url = document.getElementById('urlVideo');
                const res = await video.getFile(null);
                if (res && res.object) {
                    url.src = res.object.url;
                }
                console.log('getFile', res);
            }

            function loginAs(role) {
                alert('login as ' + role);

                const configBank = 'BANK'; // nếu không phải là khách hàng bank thì tham số này có thể không truyền

                if (role === 'admin') {
                    video.registerDevice(
                        localStorage.getItem('uuidAdmin').replace(/"/g, ''),
                        'Những Văn Hẳn'
                        // configBank
                    );
                }
            }
        </script>
    </body>
</html>
