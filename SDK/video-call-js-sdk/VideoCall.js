(function(){let t,e,n,o,i,c,s,r;const a="https://api.idg.vnpt.vn/",l=a+"router-service/api/",d={"IDG-00000000":"Thành công! - IDG-00000000","IDG-20000001":"Not null! - IDG-20000001","IDG-20000004":"Kích thước từ 0-255! - IDG-20000004","IDG-20000003":"Kích thước từ 0-4000! - IDG-20000003","IDG-20000005":"Kích thước từ 0-300! - IDG-20000005","IDG-20000006":"Không thuộc định dạng devicetype! - IDG-20000006","IDG-20000007":"Không thuộc định dạng statuscaller! - IDG-20000007","IDG-20000008":"Không thuộc kiểu enum môi trường! - IDG-20000008","IDG-20000100":"Không tìm thấy thiết bị người nhận! - IDG-20000100","IDG-20000201":"Cuộc gọi đang thực hiện! - IDG-20000201","IDG-20000202":"Không tìm thấy cuộc gọi! - IDG-20000202","IDG-20000203":"Người nhận đang trong cuộc gọi khác! - IDG-20000203","IDG-20000101":"Thiết bị người nhận và người gọi là 1! - IDG-20000101","IDG-20000210":"Không tìm thấy host! - IDG-20000210","IDG-20000404":"Không tìm thấy token! - IDG-20000404","IDG-20000211":"Không tìm thấy room! - IDG-20000211","IDG-20000213":"Không phải thiết bị nguồn! - IDG-20000213","IDG-20000214":"Không phải thiết bị đích! - IDG_20000214","IDG-20000215":"Không tồn tại cấu hình của token! - IDG_20000215","IDG-20000216":"Đã có lỗi xảy ra! - IDG-20000216","IDG-20000217":"Số lương thiết bị đăng ký vượt quá số lượng cho phép - IDG-20000217","IDG-20000218":"Thông tin người nhận không hợp lệ - IDG-20000218","IDG-20000219":"Không tìm thấy người gọi, nhận trong cuộc gọi - IDG-20000219","IDG-20000220":"Người nhận và người gọi là một người - IDG-20000220","IDG-20000420":"Cuộc gọi đã kết thúc - IDG-20000420","IDG-20000421":"Cuộc gọi bị từ chối - IDG-20000421","IDG-20000330":"Có lỗi xảy ra khi lấy file ghi âm - IDG-20000330","IDG-20000331":"Người gọi không có quyền truy cập file - IDG-20000331","IDG-20000232":"Cuộc gọi không có chế độ ghi âm, hình - IDG-20000332","IDG-20003001":"Lỗi socket time out - IDG-20000216","IDG-20003002":"Vui lòng kiểm tra kết nối mạng - IDG-20003002","IDG-20003003":"Lỗi kết nối: không kết nối được máy chủ! - IDG-20003003","IDG-20003004":"Lỗi kết nối: quá thời gian hồi đáp! - IDG-20003004","IDG-20003005":"Lỗi socket với message chi tiết - IDG-20003005","IDG-20003006":"Lỗi không xác định với message chi tiết - IDG-20003006","IDG-20002400":"Token đã bị khoá","IDG-20002401":"Bạn không có quyền truy cập","IDG-20002402":"Quá số lượng cuộc gọi đồng thời cho phép","IDG-20002403":"Quá thời lượng cuộc gọi cho phép"};window.addEventListener("message",function(t){"capture"==t.data.id&&r&&r(t.data.data)}),n=function(){const t='<div class="modalSDK" id="ratingModal" tabindex="-1" role="dialog">       <div class="modalContentSDK">           <div class="modalBodySDK">               <div id="review-form-container">                    <div id="review-form">                       <label>Đánh giá chất lượng cuộc gọi</label>                       <div class="fieldset">                            <div class="star-rating">                               <input                                    type="radio"                                   name="rating"                                   value="1"                               /><i></i>                               <input                                   type="radio"                                   name="rating"                                   value="2"                                /><i></i>                               <input                                   type="radio"                                   name="rating"                                   value="3"                               /><i></i>                               <input                                   type="radio"                                   name="rating"                                   value="4"                               /><i></i>                               <input                                   type="radio"                                   name="rating"                                   value="5"                               /><i></i>                           </div>                       </div>                       <textarea id="reviewComments" placeholder="Đánh giá chất lượng cuộc gọi" id="reviewComments" cols="20" rows="5"></textarea>                       <div class="fieldset right">                           <button id="closeRatingButton" class="btn btn-outline-danger" data-dismiss="modal">Hủy</button>                           <button id="ratingButton" class="btn btn-outline-primary" data-dismiss="modal">Gửi</button>                       </div>                   </div>               </div>           </div>       </div></div>',e='<div class="modalSDK" id="receivingCalling">       <div class="modalContentSDK">           <div class="modalBodySDK">               <div class="col-12 mb-2 text-center">                   <span id="mySpan">Bạn có một cuộc gọi video từ admin hệ thống, Bạn có muốn nhận cuộc gọi ngay lúc này?</span>               </div>               <div class="row justify-content-center mx-2">                   <button id="acceptCall" type="button" class="btnSDK btnOutlinePrimarySDK mr-2" > Đồng ý</button>                   <button id="rejectCall" type="button" class="btnSDK btnOutlineDangerSDK" data-dismiss="modal"> Hủy</button>                   </div>               </div>           </div>       </div></div>',n='<div class="modalSDK" id="msgModal" tabindex="-1" role="dialog">       <div class="modalContentSDK">           <div class="modalBodySDK">               <div class="col-12 mb-2 text-center">                  <i id="iconMsg" class="fas fa-exclamation-circle" style="color:red;font-size: 44px;"></i>               </div>               <div class="col-12 mb-2 text-center">                   <span ><b id="errMsg"></b></span>               </div>               <div class="row justify-content-center mx-2">                   <button id="closeBtn" type="button" class="btnSDK btnOutlinePrimarySDK" data-dismiss="modal"> Đóng</button>                   </div>               </div>           </div>       </div></div>';function o(){}return o.prototype.initRatingModal=function(e){const n=document.getElementById("root");let o,i;n?n.insertAdjacentHTML("afterbegin",t):document.body.insertAdjacentHTML("afterbegin",t);const c=document.querySelectorAll('input[type=radio][name="rating"]'),r=document.getElementById("reviewComments"),a=(document.getElementById("review-form"),document.getElementById("ratingModal")),l=document.getElementById("closeRatingButton"),d=document.getElementById("ratingButton");function u(t){o=this.value}r.addEventListener("change",function(t){i=this.value}),Array.prototype.forEach.call(c,function(t){t.addEventListener("change",u)}),l.onclick=function(){a.remove()},d.onclick=function(){(o||i)&&s.submitRating(e,o,i),a.remove()},a.style.display="block"},o.prototype.initReceivingModal=function(t,n){const o=document.getElementById("root");o?o.insertAdjacentHTML("afterbegin",e):document.body.insertAdjacentHTML("afterbegin",e);const i=document.getElementById("receivingCalling"),c=document.getElementById("acceptCall"),r=document.getElementById("rejectCall");document.getElementById("mySpan").innerHTML=`Bạn có một cuộc gọi video từ ${n.publisher}, Bạn có muốn nhận cuộc gọi ngay lúc này?`,c.onclick=function(){s.acceptCall(t),i.remove()},r.onclick=function(){s.rejectCall(t),i.remove()},i.style.display="block"},o.prototype.openMsgModal=function(t,e){try{const o=document.getElementById("root");o?o.insertAdjacentHTML("afterbegin",n):document.body.insertAdjacentHTML("afterbegin",n);const i=document.getElementById("errMsg"),c=document.getElementById("iconMsg");"error"===t&&c?(c.className="fas fa-exclamation-circle",c.style.color="red"):(c.className="fas fa-check-circle",c.style.color="green"),i.innerText=e||"";const s=document.getElementById("closeBtn"),r=document.getElementById("msgModal");r.style.display="block",s.onclick=function(){r.remove()}}catch(t){console.log(t)}},o}(),e=function(){function t(t,e,n){this.url=t,this.body=e,this.config=n}return t.prototype.post=async function(){try{c||await this.getAuthen();const t=await fetch(this.url,{method:"POST",mode:"cors",cache:"no-cache",credentials:"same-origin",headers:{"Content-Type":"application/json;charset=UTF-8","Token-id":this.config.token_id,"Token-key":this.config.token_key,"mac-address":"WEB-001",Authorization:c},redirect:"follow",referrerPolicy:"no-referrer",body:JSON.stringify(this.body)});if(t.ok)return t.json();const e=await t.text();throw JSON.parse(e)}catch(t){return t&&"invalid_token"===t.error?(await this.getAuthen(),this.post()):(console.log(t),i(t,t.message,null,"error"),t)}},t.prototype.get=async function(){try{c||await this.getAuthen();const t=await fetch(this.url,{method:"GET",mode:"cors",cache:"no-cache",credentials:"same-origin",headers:{"Content-Type":"application/json;charset=UTF-8","Token-id":this.config.token_id,"Token-key":this.config.token_key,"mac-address":"WEB-001",Authorization:c},redirect:"follow",referrerPolicy:"no-referrer"});if(t.ok)return t.json();const e=await t.text();throw JSON.parse(e)}catch(t){return t&&"invalid_token"===t.error?(await this.getAuthen(),this.get()):t}},t.prototype.delete=async function(){try{c||await this.getAuthen();const t=await fetch(this.url,{method:"DELETE",mode:"cors",cache:"no-cache",credentials:"same-origin",headers:{"Content-Type":"application/json;charset=UTF-8","Token-id":this.config.token_id,"Token-key":this.config.token_key,"mac-address":"WEB-001",Authorization:c},redirect:"follow",referrerPolicy:"no-referrer",body:JSON.stringify(this.body)});if(t.ok)return t.json();const e=await t.text();throw JSON.parse(e)}catch(t){return t&&"invalid_token"===t.error?(await this.getAuthen(),this.delete()):(i(t,t.message,null,"error"),t)}},t.prototype.postDataForAuthentication=async function(t,e,n){try{return(await fetch(t,{method:"POST",mode:"cors",cache:"no-cache",credentials:"same-origin",headers:{"Content-Type":"application/json"},redirect:"follow",referrerPolicy:"no-referrer",body:JSON.stringify(e)})).json()}catch(t){return t}},t.prototype.getAuthen=async function(){const t={client_id:this.config.client_id,client_secret:this.config.client_secret,grant_type:"client_credentials"},e=await this.postDataForAuthentication(a+"auth-service/oauth/token",t,this.config);return e.access_token&&(c="Bearer "+e.access_token),e.access_token},t}(),t=function(){let t,o,c,s,d,u,h=null;function g(t,e){this.config=e,this.windowCall=null,this.pageShow=!1,this.url=t,this.status="DISCONNECTED",this.api=null,this.timeout=null,this.timeoutRingtone=null}return g.prototype.registerDevice=async function(n,o,i){const c={deviceId:t(),deviceToken:n,deviceTypeId:"WEB",idgTokenId:this.config.token_id,lastDate:new Date,personIdApp:n,personName:o,topicUsing:this.getTopicUsing(n),tokenIdApp:this.config.token_id_app,configBank:i};return await new e(l+"v3/register-device",c,this.config).post()},g.prototype.createCall=async function(n,c,s,r,a){try{if("DISCONNECTED"===this.status)throw"Chưa kết nối socket, vui lòng thử lại sau!";const d={callerId:n,callerIdDest:s,callerName:c,deviceId:t(),idgTokenId:this.config.token_id,tokenIdAppDest:r,tokenIdAppSrc:this.config.token_id_app,additionalData:a,version:"3.0.0"},u=await new e(l+"v3/create-call",d,this.config).post();return"IDG-00000000"===u.message?(o("roomInfo",{roomId:u.object.roomId,token:u.object.token,domain:u.object.domain,caller:c,additionalData:a,version:"3.0.0"}),this.url&&this.openWindowCall(n),u):u}catch(t){return i("","",t||"Đã có lỗi xảy ra","error"),t}},g.prototype.acceptCall=async function(n){try{this.stopRingtone();const o=JSON.parse(c("roomInfo")),s={callerId:n,deviceId:t(),idgTokenId:this.config.token_id,roomId:o.roomId,tokenIdApp:this.config.token_id_app},r=await new e(l+"v3/accept-call",s,this.config).post();return"IDG-00000000"===r.message?(this.url&&this.openWindowCall(n),r):r}catch(t){console.log(t),i("","","Đã có lỗi xảy ra","error")}},g.prototype.endCall=async function(n){d(),this.stopTimeout();const o=JSON.parse(c("roomInfo"));let i;if(o){const c={callerId:n,deviceId:t(),idgTokenId:this.config.token_id,roomId:o.roomId,tokenIdApp:this.config.token_id_app};i=await new e(l+"v3/end-call",c,this.config).post()}return i},g.prototype.rejectCall=async function(n){this.stopTimeout(),this.stopRingtone();const o=JSON.parse(c("roomInfo")),i={callerId:n,deviceId:t(),idgTokenId:this.config.token_id,roomId:o.roomId,tokenIdApp:this.config.token_id_app};return await new e(l+"v3/reject-call",i,this.config).post()},g.prototype.removeCall=async function(t){const n=JSON.parse(c("roomInfo")),o={callerId:t,idgTokenId:this.config.token_id,roomId:n.roomId};return await new e(l+"v2/remove-call",o,this.config).post()},g.prototype.removeDevice=async function(n){const o={deviceId:t(),idgTokenId:this.config.token_id,personIdApp:n,deviceTypeId:"WEB",tokenIdApp:this.config.token_id_app};return localStorage.removeItem("roomInfo"),await new e(l+"v3/remove-device",o,this.config).delete()},g.prototype.getFile=async function(t){try{const n=JSON.parse(c("roomInfo")),o=t||n.roomId;return await new e(l+"v2/external/get-file?roomId="+o,"",this.config).get()}catch(t){console.log(t),i("","","Đã có lỗi xảy ra","error")}},g.prototype.submitRating=async function(n,o,i){const s=JSON.parse(c("roomInfo"));let r;if(s){const c={callComment:i,callQuality:o,callerId:n,deviceId:t(),idgTokenId:this.config.token_id,roomId:s.roomId};r=await new e(l+"v2/external/rating",c,this.config).post()}return r},g.prototype.setTimeoutEndcall=function(t){var e=this;this.timeout&&(clearTimeout(this.timeout),this.timeout=null),this.timeout=setTimeout(function(){console.log("The call is timeout"),e.endCall(t),e.windowCall&&e.windowCall.close()},7e4)},g.prototype.openWindowCall=function(t){try{var e=this;d();const n=void 0!==window.screenLeft?window.screenLeft:window.screenX,o=void 0!==window.screenTop?window.screenTop:window.screenY,c=window.innerWidth?window.innerWidth:document.documentElement.clientWidth?document.documentElement.clientWidth:window.screen.width,s=window.innerHeight?window.innerHeight:document.documentElement.clientHeight?document.documentElement.clientHeight:window.screen.height,r=c/window.screen.availWidth,a=(c-980)/2/r+n,l=(s-500)/2/r+o;if(this.windowCall=window.open(this.url,"videocall",`width=1280,height=600,top=${l},left=${a},menubar=yes,location=yes,resizable=yes,scrollbars=yes,status=yesnp`),window.addEventListener("offline",function(){e.windowCall.close()}),!this.windowCall)throw"404-window";this.windowCall.onbeforeunload=(e=>{this.endCall(t)})}catch(e){"404-window"===e&&(i("","","Vui lòng cho phép Pop-ups bật để thực hiện cuộc gọi ",""),this.endCall(t))}},g.prototype.handleReceivingMessage=function(t,e){switch(e.title){case"ACCEPTED":return console.log("ACCEPTED"),void this.stopTimeout();case"PENDING":return console.log("PENDING"),u(),o("roomInfo",{roomId:e.roomId,token:e.token,domain:e.domain}),this.startRingtone(),void(new n).initReceivingModal(t,e);case"REJECTED":return console.log("REJECTED"),this.stopTimeout(),i("","","Cuộc gọi đã bị từ chối!",""),this.windowCall&&this.windowCall.close(),void d();case"DENIED":return console.log("DENIED"),void d();case"FINISHED":return console.log("FINISHED"),this.stopTimeout(),this.stopRingtone(),i("","","Cuộc gọi đã kết thúc!",""),this.windowCall&&this.windowCall.close(),h&&(h.pause(),h.currentTime=0),void d();case"TIMEOUT":return console.log("timeout"),this.windowCall&&this.windowCall.close(),this.stopRingtone(),void d();default:return}},g.prototype.initSocket=async function(t,n,o,i,c){try{var r=this;let l=null;const d=await new e(null,null,this.config).getAuthen();let u=`wss://${a.replace("https://","")}router-service/websocket?access_token=${d}`,h=new WebSocket(u);s=t.over(h);let g=this.getTopicUsing(n);return s.heartbeat=c?{outgoing:3e3,incoming:3e3}:{outgoing:0,incoming:0},s.connect({},function(t){o&&o(t.command),r.status="CONNECTED",s.subscribe("/queue/"+g,function(t){const e=JSON.parse(JSON.stringify(t.body)),o=JSON.parse(e);l&&o.title===l.title&&o.roomId===l.roomId||(i&&i(JSON.parse(e)),r.handleReceivingMessage(n,o),l=o)},{id:g})},e=>{e&&"[object String]"===Object.prototype.toString.call(e)&&0===e.lastIndexOf("Whoops! Lost connection to",0)&&(o&&o("DISCONNECTED"),this.status="DISCONNECTED",setTimeout(()=>{this.initSocket(t,n,o,i,c)},3e3))}),s}catch(t){console.log(t)}},g.prototype.disconnectSocket=function(){null!==s&&s.disconnect()},g.prototype.removeIframe=function(){const t=document.querySelector("#meet");if(t&&!this.url)for(;t.firstChild;)t.removeChild(t.firstChild)},g.prototype.initVideoCall=function(e,n,o,i){try{let c=JSON.parse(localStorage.getItem("roomInfo"));document.querySelector("#meet");const s={roomName:c.roomId?c.roomId:"",width:o,height:i,jwt:c.token,configOverwrite:{subject:" "},userInfo:{displayName:c.caller,email:t()},parentNode:document.querySelector("#meet")};return this.api=new e(c.domain.replace("https://",""),s),this.api.addEventListener("readyToClose",async()=>{await this.endCall(n),window.open("","_self").close()}),this.api}catch(t){console.log(t)}},g.prototype.getTopicUsing=function(e){return this.config.token_id+"_"+this.config.token_id_app+"_"+e+"_"+t()},g.prototype.createUUID=function(){const t=([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,t=>(t^crypto.getRandomValues(new Uint8Array(1))[0]&15>>t/4).toString(16));return c("uuid")||o("uuid",t),t},g.prototype.capture=function(t){r=t,console.log(this.windowCall);const e=this.api.getIFrame(),n={id:"capture"};console.log("capture",n),e.contentWindow.postMessage(n,"*")},g.prototype.startRingtone=function(){(h=new Audio("https://ucc.vnpt.vn/assets/js/old_telephone.wav")).loop=!0,h.play(),this.timeoutRingtone&&(clearTimeout(this.timeoutRingtone),this.timeoutRingtone=null),this.timeoutRingtone=setTimeout(()=>{h&&h.pause()},7e4)},g.prototype.stopRingtone=function(){h&&(h.pause(),h.currentTime=0,h=null),clearTimeout(this.timeoutRingtone),this.timeoutRingtone=null},g.prototype.stopTimeout=function(){clearTimeout(this.timeout),this.timeout=null},d=function(){const t=document.getElementById("myModal"),e=document.getElementById("receivingCalling");t&&t.remove(),e&&e.remove()},u=function(){const t=document.getElementById("msgModal");t&&t.remove()},t=function(){try{return c("uuid")&&c("uuid").replace(/"/g,"")}catch(t){console.log(t),i("","","Lỗi không xác định","error")}},o=function(t,e){try{return localStorage.setItem(t,JSON.stringify(e)),!0}catch(t){console.log(t)}},c=function(t){try{return localStorage.getItem(t)}catch(t){}},g}(),i=function(t,e,o,i){try{t.error&&t.message&&d[t.message]?(new n).openMsgModal(i,d[t.message]):t.error&&t.message&&!d[t.message]?(new n).openMsgModal(i,"Lỗi không xác định! Vui lòng thử lại"):o?(new n).openMsgModal(i,o):"IDG-00000000"===t.message&&(new n).openMsgModal(i,d[t.message])}catch(t){console.log(t)}},o={initConfig:function(e,n){return s=new t(e,n)}},"undefined"!=typeof exports&&null!==exports&&(exports.VideoCallSDK=o),"undefined"!=typeof window&&null!==window?window.VideoCallSDK=o:exports||(self.VideoCallSDK=o)}).call(this);