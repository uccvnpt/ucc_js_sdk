const dev_url="https://api.idg.vnpt.vn/",API_ROUTER=dev_url+"router-service/api/",UUID="uuid",ROOM_INFO="roomInfo",PENDING="PENDING",ACCEPTED="ACCEPTED",REJECTED="REJECTED",FINISHED="FINISHED",TIMEOUT="TIMEOUT",DENIED="DENIED",LEAVE="LEAVE",ACCESS_TOKEN="access_token",errorCode={"IDG-00000000":"Thành công! - IDG-00000000","IDG-20000001":"Not null! - IDG-20000001","IDG-20000004":"Kích thước từ 0-255! - IDG-20000004","IDG-20000003":"Kích thước từ 0-4000! - IDG-20000003","IDG-20000005":"Kích thước từ 0-300! - IDG-20000005","IDG-20000006":"Không thuộc định dạng devicetype! - IDG-20000006","IDG-20000007":"Không thuộc định dạng statuscaller! - IDG-20000007","IDG-20000008":"Không thuộc kiểu enum môi trường! - IDG-20000008","IDG-20000100":"Không tìm thấy thiết bị người nhận! - IDG-20000100","IDG-20000201":"Cuộc gọi đang thực hiện! - IDG-20000201","IDG-20000202":"Không tìm thấy cuộc gọi! - IDG-20000202","IDG-20000203":"Người nhận đang trong cuộc gọi khác! - IDG-20000203","IDG-20000101":"Thiết bị người nhận và người gọi là 1! - IDG-20000101","IDG-20000210":"Không tìm thấy host! - IDG-20000210","IDG-20000404":"Không tìm thấy token! - IDG-20000404","IDG-20000211":"Không tìm thấy room! - IDG-20000211","IDG-20000213":"Không phải thiết bị nguồn! - IDG-20000213","IDG-20000214":"Không phải thiết bị đích! - IDG_20000214","IDG-20000215":"Không tồn tại cấu hình của token! - IDG_20000215","IDG-20000216":"Đã có lỗi xảy ra! - IDG-20000216","IDG-20000217":"Số lương thiết bị đăng ký vượt quá số lượng cho phép - IDG-20000217","IDG-20000218":"Thông tin người nhận không hợp lệ - IDG-20000218","IDG-20000219":"Không tìm thấy người gọi, nhận trong cuộc gọi - IDG-20000219","IDG-20000220":"Người nhận và người gọi là một người - IDG-20000220","IDG-20000420":"Cuộc gọi đã kết thúc - IDG-20000420","IDG-20000421":"Cuộc gọi bị từ chối - IDG-20000421","IDG-20000330":"Có lỗi xảy ra khi lấy file ghi âm - IDG-20000330","IDG-20000331":"Người gọi không có quyền truy cập file - IDG-20000331","IDG-20000232":"Cuộc gọi không có chế độ ghi âm, hình - IDG-20000332","IDG-20003001":"Lỗi socket time out - IDG-20000216","IDG-20003002":"Vui lòng kiểm tra kết nối mạng - IDG-20003002","IDG-20003003":"Lỗi kết nối: không kết nối được máy chủ! - IDG-20003003","IDG-20003004":"Lỗi kết nối: quá thời gian hồi đáp! - IDG-20003004","IDG-20003005":"Lỗi socket với message chi tiết - IDG-20003005","IDG-20003006":"Lỗi không xác định với message chi tiết - IDG-20003006","IDG-20002400":"Token đã bị khoá","IDG-20002401":"Bạn không có quyền truy cập","IDG-20002402":"Quá số lượng cuộc gọi đồng thời cho phép","IDG-20002403":"Quá thời lượng cuộc gọi cho phép"},renderIframe='<div id="meet"></div>',receivingCalling='<div class="modalSDK" id="receivingCalling">       <div class="modalContentSDK">           <div class="modalBodySDK">               <div class="col-12 mb-2 text-center">                   <span>Bạn có một cuộc gọi video từ admin hệ thống, Bạn có muốn nhận cuộc gọi ngay lúc này?</span>               </div>               <div class="row justify-content-center mx-2">                   <button id="acceptCall" type="button" class="btnSDK btnOutlinePrimarySDK mr-2" > Đồng ý</button>                   <button id="rejectCall" type="button" class="btnSDK btnOutlineDangerSDK" data-dismiss="modal"> Hủy</button>                   </div>               </div>           </div>       </div></div>',msgModal='<div class="modalSDK" id="msgModal" tabindex="-1" role="dialog">       <div class="modalContentSDK">           <div class="modalBodySDK">               <div class="col-12 mb-2 text-center">                  <i id="iconMsg" class="fas fa-exclamation-circle" style="color:red;font-size: 44px;"></i>               </div>               <div class="col-12 mb-2 text-center">                   <span ><b id="errMsg"></b></span>               </div>               <div class="row justify-content-center mx-2">                   <button id="closeBtn" type="button" class="btnSDK btnOutlinePrimarySDK" data-dismiss="modal"> Đóng</button>                   </div>               </div>           </div>       </div></div>',initModal='<div class="modalSDK show" id="myModal" tabindex="-1" role="dialog">   <div class="modal-dialog" role="document">       <div class="modalContentSDK">           <div class="modalBodySDK">               <div class="row justify-content-center mb-2">                   <img id="avatar" src="" width="200" height="200" alt="avatar" style="border-radius:50%">               </div>               <div class="col-12 mb-2 text-center">                   <h4><label id="userName"></label></h4>               </div>               <div class="col-12 mb-2 text-center">                   <i class="fa fa-phone" aria-hidden="true"></i>                   <span><i>Đang gọi...</i></span>               </div>               <div class="col-12 mb-2 text-center">                   <span class="text-danger"><i>Cuộc gọi sẽ được tự động ghi lại</i></span>               </div>               <div class="row justify-content-center">                           <div class="ring" id="cancleCall">                               <div class="vdc-alo-phone vdc-alo-green vdc-alo-show" >                               <div class="vdc-alo-ph-circle"></div>                               <div class="vdc-alo-ph-circle-fill"></div>                               <div class="vdc-alo-ph-img-circle"></div>                           </div>               </div>           </div>       </div>   </div></div>',initModal2='<div class="modal" id="myModal">       <div class="modal-content">           <div class="modal-body">               <div class="row justify-content-center mb-2">                   <img id="avatar" src="" width="200" height="200" alt="avatar" style="border-radius:50%">               </div>               <div class="col-12 mb-2 text-center">                   <h4><label id="userName"></label></h4>               </div>               <div class="col-12 mb-2 text-center">                   <i class="fa fa-phone" aria-hidden="true"></i>                   <span><i>Đang gọi...</i></span>               </div>               <div class="col-12 mb-2 text-center">                   <span class="text-danger"><i>Cuộc gọi sẽ được tự động ghi lại</i></span>               </div>               <div class="row justify-content-center">                           <div class="ring" id="cancleCall">                               <div class="vdc-alo-phone vdc-alo-green vdc-alo-show" >                               <div class="vdc-alo-ph-circle"></div>                               <div class="vdc-alo-ph-circle-fill"></div>                               <div class="vdc-alo-ph-img-circle"></div>                           </div>               </div>           </div>       </div></div>',initRating='<div class="modalSDK" id="ratingModal" tabindex="-1" role="dialog">       <div class="modalContentSDK">           <div class="modalBodySDK">               <div id="review-form-container">                    <div id="review-form">                       <label>Đánh giá chất lượng cuộc gọi</label>                       <div class="fieldset">                            <div class="star-rating">                               <input                                    type="radio"                                   name="rating"                                   value="1"                               /><i></i>                               <input                                   type="radio"                                   name="rating"                                   value="2"                                /><i></i>                               <input                                   type="radio"                                   name="rating"                                   value="3"                               /><i></i>                               <input                                   type="radio"                                   name="rating"                                   value="4"                               /><i></i>                               <input                                   type="radio"                                   name="rating"                                   value="5"                               /><i></i>                           </div>                       </div>                       <textarea id="reviewComments" placeholder="Đánh giá chất lượng cuộc gọi" id="reviewComments" cols="20" rows="5"></textarea>                       <div class="fieldset right">                           <button id="closeRatingButton" class="btn btn-outline-danger" data-dismiss="modal">Hủy</button>                           <button id="ratingButton" class="btn btn-outline-primary" data-dismiss="modal">Gửi</button>                       </div>                   </div>               </div>           </div>       </div></div>',VideoCall=function(){let e,t=null,n=null,i=!1,o=null,c=null,a=null;function r(e,t){const n=document.getElementById("root");n?n.insertAdjacentHTML("afterbegin",receivingCalling):document.body.insertAdjacentHTML("afterbegin",receivingCalling);const i=document.getElementById("receivingCalling"),o=document.getElementById("acceptCall"),a=document.getElementById("rejectCall");o.onclick=function(){!async function(e){try{const t=JSON.parse(k(ROOM_INFO)),n={callerId:e,deviceId:I(),idgTokenId:c.token_id,roomId:t.roomId},i=await D(API_ROUTER+"v2/accept-call",n);"IDG-00000000"===i.message?u(e):w(i,i.message,null,"error")}catch(t){y(e),w("","","Vui lòng cho phép Pop-ups bật để thực hiện cuộc gọi ","error")}}(e),i.style.display="none"},a.onclick=function(){!async function(e){const t=JSON.parse(k(ROOM_INFO)),n={callerId:e,deviceId:I(),idgTokenId:c.token_id,roomId:t.roomId};await D(API_ROUTER+"v2/reject-call",n)}(e),i.style.display="none"},i.style.display="block"}function d(e,t){const n=document.getElementById("root");n?n.insertAdjacentHTML("afterbegin",msgModal):document.body.insertAdjacentHTML("afterbegin",msgModal);const i=document.getElementById("errMsg"),o=document.getElementById("iconMsg");"error"===e&&o?(o.className="fas fa-exclamation-circle",o.style.color="red"):(o.className="fas fa-check-circle",o.style.color="green"),i.innerText=t||"";const c=document.getElementById("closeBtn"),a=document.getElementById("msgModal");a.style.display="block",c.onclick=function(){a.style.display="none"}}function l(n){e=setTimeout(function(){y(n),t&&t.close(),s()},7e4)}function s(){clearTimeout(e)}function g(e,n){switch(function(){const e=document.getElementById("msgModal");e&&(e.style.display="none")}(),n.title){case ACCEPTED:return console.log("ACCEPTED"),void s();case PENDING:return console.log("PENDING"),E(ROOM_INFO,{roomId:n.roomId,token:n.token,domain:n.domain}),r(e),void l(e);case REJECTED:return console.log("REJECTED"),w("","","Cuộc gọi đã bị từ chối!",""),t&&t.close(),void m();case DENIED:return console.log("DENIED"),void m();case FINISHED:return console.log("FINISHED"),w("","","Cuộc gọi đã kết thúc!",""),t&&t.close(),void m();case TIMEOUT:return console.log("timeout"),t&&t.close(),void m();default:return}}function u(e){m();const n=void 0!==window.screenLeft?window.screenLeft:window.screenX,o=void 0!==window.screenTop?window.screenTop:window.screenY,c=window.innerWidth?window.innerWidth:document.documentElement.clientWidth?document.documentElement.clientWidth:window.screen.width,r=window.innerHeight?window.innerHeight:document.documentElement.clientHeight?document.documentElement.clientHeight:window.screen.height,d=c/window.screen.availWidth,l=(c-980)/2/d+n,s=(r-500)/2/d+o;t=window.open(a,"videocall",`width=1280,height=600,top=${s},left=${l},menubar=yes,location=yes,resizable=yes,scrollbars=yes,status=yesnp`),window.addEventListener("offline",()=>{t.close()}),t.onpageshow=(e=>{i=!0}),t.onpagehide=(t=>{i&&(y(e),i=!1)})}function m(){const e=document.getElementById("myModal"),t=document.getElementById("receivingCalling");e&&(e.style.display="none"),t&&(t.style.display="none")}function h(){return([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,e=>(e^crypto.getRandomValues(new Uint8Array(1))[0]&15>>e/4).toString(16))}function v(e){return c.token_id+"_"+e+"_"+I()}function I(){try{return k(UUID)&&k(UUID).replace(/"/g,"")}catch(e){w("","","Lỗi không xác định","error")}}async function y(e){m(),s();const t=JSON.parse(k(ROOM_INFO));let n;if(t){const i={callerId:e,deviceId:I(),idgTokenId:c.token_id,roomId:t.roomId};n=await D(API_ROUTER+"v2/end-call",i)}return n}async function p(){const e={client_id:c.client_id,client_secret:c.client_secret,grant_type:"client_credentials"},t=await async function(e,t){try{k(ACCESS_TOKEN);const n=await fetch(e,{method:"POST",mode:"cors",cache:"no-cache",credentials:"same-origin",headers:{"Content-Type":"application/json"},redirect:"follow",referrerPolicy:"no-referrer",body:JSON.stringify(t)});return n.json()}catch(e){return e}}(dev_url+"auth-service/oauth/token",e);return t.access_token&&(n="Bearer "+t.access_token),t.access_token}async function D(e="",t={}){try{n||await p();const i=await fetch(e,{method:"POST",mode:"cors",cache:"no-cache",credentials:"same-origin",headers:{"Content-Type":"application/json;charset=UTF-8","Token-id":c.token_id,"Token-key":c.token_key,"mac-address":"WEB-001",Authorization:n},redirect:"follow",referrerPolicy:"no-referrer",body:JSON.stringify(t)});if(i.ok)return i.json();const o=await i.text();throw JSON.parse(o)}catch(n){return n&&"invalid_token"===n.error?(await p(),D(e,t)):(w(n,n.message,null,"error"),n)}}async function f(e="",t=""){try{n||await p();const i=await fetch(e,{method:"GET",mode:"cors",withCredentials:!0,cache:"no-cache",credentials:"same-origin",headers:{"Content-Type":"application/json","Token-id":c.token_id,"Token-key":c.token_key,"mac-address":"WEB-001",Authorization:n},redirect:"follow",referrerPolicy:"no-referrer"});if(i.ok)return i.json();const o=await i.text();throw JSON.parse(o)}catch(n){return n&&"invalid_token"===n.error?(await p(),f(e,t)):(w(n,n.message,null,"error"),n)}}function w(e,t,n,i){e.error&&e.message&&errorCode[e.message]?d(i,errorCode[e.message]):e.error&&e.message&&!errorCode[e.message]?d(i,"Lỗi không xác định! Vui lòng thử lại"):n?d(i,n):"IDG-00000000"===e.message&&d(i,errorCode[e.message])}function E(e,t){try{return localStorage.setItem(e,JSON.stringify(t)),!0}catch(e){}}function k(e){try{return localStorage.getItem(e)}catch(e){}}return{getUUID:I,getTopicUsing:v,handleReceivingMessage:g,removeDevice:async function(e){const t={deviceId:I(),idgTokenId:c.token_id,personIdApp:e,deviceTypeId:"WEB"},i=await async function e(t="",i={}){try{n||await p();const o=await fetch(t,{method:"DELETE",mode:"cors",cache:"no-cache",credentials:"same-origin",headers:{"Content-Type":"application/json","Token-id":c.token_id,"Token-key":c.token_key,"mac-address":"WEB-001",Authorization:n},redirect:"follow",referrerPolicy:"no-referrer",body:JSON.stringify(i)});if(o.ok)return o.json();const a=await o.text();throw JSON.parse(a)}catch(n){return n&&"invalid_token"===n.error?(await p(),e(t,i)):(w(n,n.message,null,"error"),n)}}(API_ROUTER+"v2/remove-device",t);return localStorage.removeItem(ROOM_INFO),localStorage.removeItem(ACCESS_TOKEN),i},createCall:async function(e,t="",n,i){try{const i={callerId:e,callerName:t,deviceId:I(),idgTokenId:c.token_id,reciverCallers:n},o=await D(API_ROUTER+"v2/create-call",i);return"IDG-00000000"===o.message?(E(ROOM_INFO,{roomId:o.object.roomId,token:o.object.token,domain:o.object.domain,caller:t}),u(e),l(e),o):o}catch(t){y(e),w("",0,"Vui lòng cho phép Pop-ups bật để thực hiện cuộc gọi ","error")}},registerDevice:async function(e,t,n){const i={deviceId:I(),deviceToken:e,deviceTypeId:"WEB",idgTokenId:c.token_id,lastDate:new Date,personIdApp:t,personName:n,topicUsing:v(t)};return D(API_ROUTER+"v2/register-device",i)},endCall:y,createUUID:function(){return k(UUID)||E(UUID,h()),h()},getFile:async function(e){try{const t=JSON.parse(k(ROOM_INFO)),n=e||t.roomId;return await f(API_ROUTER+"v2/external/get-file?roomId="+n,"")}catch(e){w("",0,"Đã có lỗi xảy ra","error")}},getAuthen:p,initRatingModal:function(e){const t=document.getElementById("root");let n,i;t?t.insertAdjacentHTML("afterbegin",initRating):document.body.insertAdjacentHTML("afterbegin",initRating);const o=document.querySelectorAll('input[type=radio][name="rating"]'),a=document.getElementById("reviewComments"),r=(document.getElementById("review-form"),document.getElementById("ratingModal")),d=document.getElementById("closeRatingButton"),l=document.getElementById("ratingButton");function s(e){n=this.value}a.addEventListener("change",function(e){i=this.value}),Array.prototype.forEach.call(o,function(e){e.addEventListener("change",s)}),d.onclick=function(){r.style.display="none"},l.onclick=function(){(n||i)&&async function(e,t,n){const i=JSON.parse(k(ROOM_INFO));let o;if(i){const a={callComment:n,callQuality:t,callerId:e,deviceId:I(),idgTokenId:c.token_id,roomId:i.roomId};o=await D(API_ROUTER+"v2/external/rating",a)}}(e,n,i),r.style.display="none"},r.style.display="block"},initSocket:async function e(t,i,c,a){try{await p();let r=n.replace("Bearer ",""),d=`wss://${dev_url.replace("https://","")}router-service/websocket?access_token=${r}`,l=new WebSocket(d);o=t.over(l);let s=v(i);return o.heartbeat={outgoing:0,incoming:0},o.connect({},e=>{c&&c(e.command),o.subscribe("/topic/"+s,function(e){const t=JSON.parse(JSON.stringify(e.body));a&&a(JSON.parse(t)),g(i,JSON.parse(t))},{id:s})},n=>{n&&"[object String]"===Object.prototype.toString.call(n)&&0===n.lastIndexOf("Whoops! Lost connection to",0)&&setTimeout(()=>{e(t,i,c,a)},3e3)}),o}catch(e){}},disconnectSocket:function(){null!==o&&o.disconnect()},version:"2.0.8",initVideoCall:function(e,t,n,i){let o=JSON.parse(localStorage.getItem("roomInfo"));const c={roomName:o.roomId?o.roomId:"",width:n,height:i,jwt:o.token,configOverwrite:{subject:" "},userInfo:{displayName:o.caller,email:I()},parentNode:document.querySelector("#meet")};let a=new e(o.domain.replace("https://",""),c);return a.addEventListener("readyToClose",async()=>{await y(t),window.open("","_self").close()}),a},initConfig:function(e,t){c=t,a=e}}};